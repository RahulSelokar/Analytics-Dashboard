<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dropshipping Business & Sales Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #f8fafc;
      min-height: 100vh;
      padding: 32px;
      color: #0f172a;
      transition: background .25s ease, color .25s ease;
    }

    .container { 
      max-width: 1600px; 
      margin: 0 auto;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: #cbd5e1;
    }

    .topbar { 
      padding: 32px;
      margin-bottom: 24px;
      animation: slideDown 0.5s ease-out;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .topbar h2 { 
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
      transition: color .25s ease;
    }

    .muted { 
      color: #64748b; 
      font-size: 14px;
      font-weight: 500;
      transition: color .25s ease;
    }

    .chips { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .chip { 
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      cursor: pointer;
      border-radius: 8px;
      text-decoration: none;
      color: #475569;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .chip:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .chip.active { 
      background: #0f172a;
      color: #ffffff;
      border-color: #0f172a;
    }

    .filter-card {
      padding: 24px 32px;
      margin-bottom: 24px;
      animation: slideUp 0.5s ease-out 0.1s backwards;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .row { 
      display: flex; 
      gap: 20px; 
      flex-wrap: wrap; 
      align-items: center;
    }

    select, input[type="date"] {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #ffffff;
      min-width: 180px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      color: #0f172a;
    }

    select:focus, input[type="date"]:focus {
      outline: none;
      border-color: #475569;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    button {
      padding: 10px 20px;
      border: none;
      background: #0f172a;
      color: #ffffff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }

    button:hover {
      background: #1e293b;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(15, 23, 42, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    /* Dark mode toggle button (keeps same UI style) */
    .ghost-btn{
      background:#ffffff;
      color:#0f172a;
      border:1px solid #e2e8f0;
    }
    .ghost-btn:hover{
      background:#f1f5f9;
      box-shadow:none;
      transform:none;
    }

    .grid4 { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 20px;
      margin-bottom: 24px;
    }

    .kpi-card {
      padding: 24px;
      position: relative;
      border-left: 4px solid transparent;
      transition: all 0.3s ease;
    }

    .kpi-card:nth-child(1) { border-left-color: #3b82f6; }
    .kpi-card:nth-child(2) { border-left-color: #10b981; }
    .kpi-card:nth-child(3) { border-left-color: #f59e0b; }
    .kpi-card:nth-child(4) { border-left-color: #ef4444; }

    .kpi-card:hover {
      transform: translateY(-2px);
    }

    /* clickable KPIs */
    .kpi-clickable { cursor:pointer; }
    .kpi-clickable:focus { outline:none; }

    .kpi-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .kpi-icon{
      width:40px;
      height:40px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      font-weight:700;
      color:#0f172a;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      flex:0 0 auto;
      transition: background .25s ease, border-color .25s ease, color .25s ease;
    }

    .kpi { 
      font-size: 32px;
      font-weight: 800;
      color: #0f172a;
      letter-spacing: -1px;
      transition: color .25s ease;
    }

    .grid2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px;
      margin-bottom: 24px;
    }

    .grid3 { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 20px;
      margin-bottom: 24px;
    }

    .chart-card {
      padding: 24px;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .chart-card b {
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
      transition: color .25s ease;
    }

    .badge {
      padding: 4px 10px;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background .25s ease, color .25s ease;
    }

    canvas { 
      max-height: 300px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 13px;
      margin-top: 16px;
    }

    thead {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      transition: background .25s ease, border-color .25s ease;
    }

    th { 
      padding: 12px;
      text-align: left;
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      transition: color .25s ease;
    }

    td { 
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
      transition: color .25s ease, background .25s ease, border-color .25s ease;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .right { text-align: right; }

    td:last-child {
      font-weight: 600;
      font-size: 12px;
    }

    .loading { 
      opacity: 0.5;
      pointer-events: none;
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 32px;
      height: 32px;
      margin: -16px 0 0 -16px;
      border: 3px solid #f1f5f9;
      border-top-color: #0f172a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .grid4 > *:nth-child(1) { animation: slideUp 0.5s ease-out 0.1s backwards; }
    .grid4 > *:nth-child(2) { animation: slideUp 0.5s ease-out 0.15s backwards; }
    .grid4 > *:nth-child(3) { animation: slideUp 0.5s ease-out 0.2s backwards; }
    .grid4 > *:nth-child(4) { animation: slideUp 0.5s ease-out 0.25s backwards; }

    .grid2 > *:nth-child(1) { animation: slideUp 0.5s ease-out 0.3s backwards; }
    .grid2 > *:nth-child(2) { animation: slideUp 0.5s ease-out 0.35s backwards; }

    .grid3 > *:nth-child(1) { animation: slideUp 0.5s ease-out 0.4s backwards; }
    .grid3 > *:nth-child(2) { animation: slideUp 0.5s ease-out 0.45s backwards; }
    .grid3 > *:nth-child(3) { animation: slideUp 0.5s ease-out 0.5s backwards; }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin: 32px 0 16px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
      transition: color .25s ease, border-color .25s ease;
    }

    /* Underperforming agencies styling */
    .row-bad{
      background:#fff1f2 !important;
      font-weight:700;
    }
    .status-bad{ color:#dc2626; }
    .status-ok{ color:#16a34a; }

    /* ========== DARK MODE (no UI/UX disturbance) ========== */
    body.dark { background:#0b1220; color:#e5e7eb; }
    body.dark .card { background:#111827; border-color:#1f2937; box-shadow:none; }
    body.dark .card:hover { border-color:#334155; box-shadow:none; }
    body.dark .topbar h2 { color:#e5e7eb; }
    body.dark .muted { color:#9ca3af; }
    body.dark select, body.dark input[type="date"]{
      background:#0f172a; border-color:#1f2937; color:#e5e7eb;
    }
    body.dark select:focus, body.dark input[type="date"]:focus{
      border-color:#94a3b8; box-shadow:0 0 0 3px rgba(148,163,184,0.15);
    }
    body.dark .chip{ background:#0f172a; border-color:#1f2937; color:#e5e7eb; }
    body.dark .chip:hover{ background:#111827; border-color:#334155; }
    body.dark .chip.active{ background:#e5e7eb; color:#0f172a; border-color:#e5e7eb; }
    body.dark .badge{ background:#0f172a; color:#9ca3af; }
    body.dark thead{ background:#0f172a; border-bottom-color:#1f2937; }
    body.dark th{ color:#cbd5e1; }
    body.dark td{ color:#e5e7eb; border-bottom-color:#1f2937; }
    body.dark tbody tr:hover{ background:#0f172a; }
    body.dark .section-title{ color:#e5e7eb; border-bottom-color:#1f2937; }
    body.dark .kpi{ color:#e5e7eb; }
    body.dark .kpi-icon{
      background:#0f172a; border-color:#1f2937; color:#e5e7eb;
    }
    body.dark .ghost-btn{
      background:#0f172a; color:#e5e7eb; border-color:#1f2937;
    }
    body.dark .ghost-btn:hover{
      background:#111827; border-color:#334155;
    }

    @media (max-width: 1200px) { 
      .grid4 { grid-template-columns: repeat(2, 1fr); }
      .grid3 { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) { 
      .grid4, .grid2, .grid3 { grid-template-columns: 1fr; }
      body { padding: 16px; }
      .topbar { padding: 24px; }
      .topbar h2 { font-size: 22px; }
      .kpi { font-size: 28px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card topbar">
    <div>
      <h2>üè™ Dropshipping Business & Sales Analysis</h2>
      <div class="muted" id="dateRangeText">
        Showing: {{ payload.meta.start_date }} to {{ payload.meta.end_date }}
      </div>
    </div>

    <!-- Dark mode toggle (keeps UI consistent) -->
    <div>
      <button id="themeToggle" class="ghost-btn">üåô Dark</button>
    </div>
  </div>

  <div class="card filter-card">
    <div class="row">
      <div>
        <div class="muted" style="margin-bottom: 6px;">Platform</div>
        <select id="platformSelect">
          {% for opt in platform_options %}
            <option value="{{ opt }}" {% if opt == platform %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <div class="muted" style="margin-bottom: 6px;">Agency</div>
        <select id="agencySelect">
          {% for opt in agency_options %}
            <option value="{{ opt }}" {% if opt == agency %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="chips" id="presetChips">
        <a class="chip {% if preset == 'today' %}active{% endif %}" href="#" data-preset="today">Today</a>
        <a class="chip {% if preset == 'this_week' %}active{% endif %}" href="#" data-preset="this_week">This Week</a>
        <a class="chip {% if preset == 'this_month' %}active{% endif %}" href="#" data-preset="this_month">This Month</a>
        <a class="chip {% if preset == 'last_month' %}active{% endif %}" href="#" data-preset="last_month">Last Month</a>
        <a class="chip {% if preset == 'this_quarter' %}active{% endif %}" href="#" data-preset="this_quarter">This Quarter</a>
        <a class="chip {% if preset == 'custom' %}active{% endif %}" href="#" data-preset="custom">Custom</a>
      </div>

      <div id="customDateBox" style="{% if preset != 'custom' %}display:none;{% endif %}">
        <div class="row" style="align-items:flex-end;">
          <div>
            <div class="muted" style="margin-bottom: 6px;">From</div>
            <input type="date" id="fromDate" value="{{ from_date }}">
          </div>
          <div>
            <div class="muted" style="margin-bottom: 6px;">To</div>
            <input type="date" id="toDate" value="{{ to_date }}">
          </div>
          <div>
            <button id="applyCustomBtn">Apply Dates</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs (icons + click -> drilldown) -->
  <div class="grid4" id="kpiGrid">
    <div class="card kpi-card kpi-clickable" role="button" tabindex="0" onclick="drilldown('orders')">
      <div class="muted">Total Orders</div>
      <div class="kpi-row">
        <div class="kpi-icon">üì¶</div>
        <div class="kpi" id="kpiOrders">{{ payload.kpis.total_orders }}</div>
      </div>
    </div>

    <div class="card kpi-card kpi-clickable" role="button" tabindex="0" onclick="drilldown('revenue')">
      <div class="muted">Total Revenue</div>
      <div class="kpi-row">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi" id="kpiRevenue">‚Çπ {{ payload.kpis.total_revenue }}</div>
      </div>
    </div>

    <div class="card kpi-card kpi-clickable" role="button" tabindex="0" onclick="drilldown('items')">
      <div class="muted">Total Items Sold</div>
      <div class="kpi-row">
        <div class="kpi-icon">üõí</div>
        <div class="kpi" id="kpiItems">{{ payload.kpis.total_items }}</div>
      </div>
    </div>

    <div class="card kpi-card kpi-clickable" role="button" tabindex="0" onclick="drilldown('spend')">
      <div class="muted">Total Ads Spend</div>
      <div class="kpi-row">
        <div class="kpi-icon">üì¢</div>
        <div class="kpi" id="kpiSpend">‚Çπ {{ payload.kpis.total_ads_spend }}</div>
      </div>
    </div>
  </div>

  <!-- Profit & ROI KPI row (keeps same UI/UX) -->
  <div class="grid4" id="kpiGrid2" style="margin-bottom:24px;">
    <div class="card kpi-card kpi-clickable" role="button" tabindex="0" onclick="drilldown('profit')" style="border-left-color:#16a34a;">
      <div class="muted">Gross Profit</div>
      <div class="kpi-row">
        <div class="kpi-icon">üü¢</div>
        <div class="kpi" id="kpiProfit">‚Çπ {{ payload.kpis.gross_profit|default:0 }}</div>
      </div>
    </div>

    <div class="card kpi-card kpi-clickable" role="button" tabindex="0" onclick="drilldown('roi')" style="border-left-color:#8b5cf6;">
      <div class="muted">ROI</div>
      <div class="kpi-row">
        <div class="kpi-icon">üìà</div>
        <div class="kpi" id="kpiROI">{{ payload.kpis.roi|default:0 }}%</div>
      </div>
    </div>

    <!-- Keep layout balanced (same UI/UX) -->
    <div class="card kpi-card" style="border-left-color:#06b6d4;">
      <div class="muted">Avg Order Value</div>
      <div class="kpi-row">
        <div class="kpi-icon">üßæ</div>
        <div class="kpi" id="kpiAOV">‚Çπ {{ payload.kpis.avg_order_value|default:0 }}</div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:12px;">(optional KPI)</div>
    </div>

    <div class="card kpi-card" style="border-left-color:#f97316;">
      <div class="muted">Cost per Order (CPO)</div>
      <div class="kpi-row">
        <div class="kpi-icon">üéØ</div>
        <div class="kpi" id="kpiCPO">‚Çπ {{ payload.kpis.overall_cpo|default:0 }}</div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:12px;">(optional KPI)</div>
    </div>
  </div>

  <div class="grid2" id="chartsTop">
    <div class="card chart-card">
      <div class="chart-header">
        <b>Revenue Trend (Daily)</b>
        <span class="badge">Line Chart</span>
      </div>
      <canvas id="revenueLine"></canvas>
    </div>

    <div class="card chart-card">
      <div class="chart-header">
        <b>Platform Split (Orders)</b>
        <span class="badge">Doughnut</span>
      </div>
      <canvas id="platformDoughnut"></canvas>
    </div>
  </div>

  <div class="grid3" id="chartsMid">
    <div class="card chart-card">
      <div class="chart-header">
        <b>Top 10 Products (Revenue)</b>
        <span class="badge">Bar Chart</span>
      </div>
      <canvas id="topProductsBar"></canvas>
    </div>

    <div class="card chart-card">
      <div class="chart-header">
        <b>Top 3 Agencies (Orders)</b>
        <span class="badge">Pie Chart</span>
      </div>
      <canvas id="topAgenciesPie"></canvas>
    </div>

    <div class="card chart-card">
      <div class="chart-header">
        <b>Top 3 Ads (Orders)</b>
        <span class="badge">Polar Area</span>
      </div>
      <canvas id="topAdsPolar"></canvas>
    </div>
  </div>

  <div class="card chart-card" style="margin-bottom: 24px; animation: slideUp 0.5s ease-out 0.55s backwards;" id="campaignCard">
    <div class="chart-header">
      <b>Cost per Campaign & Orders per Campaign</b>
      <span class="badge">Mixed Chart</span>
    </div>
    <canvas id="campaignMixed"></canvas>
    <div style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>Campaign</th>
            <th class="right">Orders</th>
            <th class="right">Spend (‚Çπ)</th>
            <th class="right">CPO (‚Çπ)</th>
          </tr>
        </thead>
        <tbody id="campaignTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Underperforming Agencies -->
  <div class="card chart-card" style="margin-bottom:24px;" id="underperformCard">
    <div class="chart-header">
      <b>‚ö†Ô∏è Underperforming Agencies</b>
      <span class="badge">Auto Analysis</span>
    </div>
    <div class="muted">Highlighted rows indicate agencies that need attention (high CPO / low orders).</div>
    <table>
      <thead>
        <tr>
          <th>Agency</th>
          <th class="right">Orders</th>
          <th class="right">Spend (‚Çπ)</th>
          <th class="right">CPO (‚Çπ)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="agencyPerfBody"></tbody>
    </table>
  </div>

  <div class="section-title">Order Details</div>

  <div class="grid3" id="listsGrid" style="animation: slideUp 0.5s ease-out 0.6s backwards;">
    <div class="card chart-card">
      <b>Recent Orders (Last 10)</b>
      <div class="muted">Most recent transactions</div>
      <table>
        <thead><tr><th>Date</th><th>Product</th><th>Agency</th><th class="right">Amount</th><th>Status</th></tr></thead>
        <tbody id="recentOrdersBody"></tbody>
      </table>
    </div>

    <div class="card chart-card">
      <b>Orders Waiting for Pickup</b>
      <div class="muted">Status: WAITING_PICKUP</div>
      <table>
        <thead><tr><th>Date</th><th>Product</th><th>Campaign</th><th class="right">Amount</th></tr></thead>
        <tbody id="waitingPickupBody"></tbody>
      </table>
    </div>

    <div class="card chart-card">
      <b>Orders Delivered</b>
      <div class="muted">Status: DELIVERED</div>
      <table>
        <thead><tr><th>Date</th><th>Product</th><th>Agency</th><th class="right">Amount</th></tr></thead>
        <tbody id="deliveredBody"></tbody>
      </table>
    </div>
  </div>
</div>

<hr />
<div class="footer" style="text-align:center; padding:16px; font-size:14px; color:#64748b;">
Dropping Dashboard Vs. 1.00 |  Made with Love ‚ù§Ô∏è Zappkode Solutions 2025
</div>

<script>
  const COLORS = [
    "#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6",
    "#06b6d4", "#ec4899", "#14b8a6", "#f97316", "#6366f1"
  ];

  let chartRevenueLine, chartPlatformDoughnut, chartTopProductsBar, chartTopAgenciesPie, chartTopAdsPolar, chartCampaignMixed;
  let currentPreset = "{{ preset }}";

  function setLoading(isLoading) {
    const ids = ["kpiGrid", "kpiGrid2", "chartsTop", "chartsMid", "campaignCard", "underperformCard", "listsGrid"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle("loading", isLoading);
    });
  }

  function qs() {
    return {
      preset: currentPreset,
      platform: document.getElementById("platformSelect").value,
      agency: document.getElementById("agencySelect").value,
      from: document.getElementById("fromDate") ? document.getElementById("fromDate").value : "",
      to: document.getElementById("toDate") ? document.getElementById("toDate").value : "",
    };
  }

  function buildUrl() {
    const p = qs();
    const url = new URL("/api/dashboard-data/", window.location.origin);
    url.searchParams.set("preset", p.preset);
    url.searchParams.set("platform", p.platform);
    url.searchParams.set("agency", p.agency);
    if (p.preset === "custom") {
      url.searchParams.set("from", p.from);
      url.searchParams.set("to", p.to);
    }
    return url.toString();
  }

  // KPI drilldown navigation
  function drilldown(view){
    const p = qs();
    const url = new URL("/orders/", window.location.origin);  // you will create this page in Django
    url.searchParams.set("view", view);
    url.searchParams.set("preset", p.preset);
    url.searchParams.set("platform", p.platform);
    url.searchParams.set("agency", p.agency);
    if(p.preset === "custom"){
      url.searchParams.set("from", p.from);
      url.searchParams.set("to", p.to);
    }
    window.location.href = url.toString();
  }

  function renderTables(payload) {
    const campBody = document.getElementById("campaignTableBody");
    campBody.innerHTML = "";
    const camps = payload.charts.campaign_perf || [];
    if (camps.length === 0) {
      campBody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:#64748b;">No campaigns in selected period.</td></tr>`;
    } else {
      camps.forEach(c => {
        campBody.innerHTML += `
          <tr>
            <td>${c.campaign__campaign_name}</td>
            <td class="right">${c.orders}</td>
            <td class="right">‚Çπ ${Number(c.spend).toFixed(2)}</td>
            <td class="right">‚Çπ ${Number(c.cpo).toFixed(2)}</td>
          </tr>
        `;
      });
    }

    // Underperforming agencies
    const ap = document.getElementById("agencyPerfBody");
    ap.innerHTML = "";
    const agencies = payload.underperforming_agencies || [];
    if(!agencies.length){
      ap.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#64748b;">No agency data in selected period.</td></tr>`;
    } else {
      agencies.forEach(a=>{
        const bad = a.status === "UNDERPERFORMING";
        ap.innerHTML += `
          <tr class="${bad ? 'row-bad' : ''}">
            <td>${a.agency__name}</td>
            <td class="right">${a.orders}</td>
            <td class="right">‚Çπ ${Number(a.spend).toFixed(2)}</td>
            <td class="right">‚Çπ ${Number(a.cpo).toFixed(2)}</td>
            <td class="${bad ? 'status-bad' : 'status-ok'}">${a.status}</td>
          </tr>
        `;
      });
    }

    const ro = document.getElementById("recentOrdersBody");
    ro.innerHTML = "";
    const recent = payload.lists.recent_orders || [];
    if (recent.length === 0) {
      ro.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#64748b;">No orders.</td></tr>`;
    } else {
      recent.forEach(o => {
        ro.innerHTML += `
          <tr>
            <td>${o.order_date}</td>
            <td>${o.product__name}</td>
            <td>${o.agency__name}</td>
            <td class="right">‚Çπ ${Number(o.order_value).toFixed(2)}</td>
            <td>${o.status}</td>
          </tr>
        `;
      });
    }

    const wp = document.getElementById("waitingPickupBody");
    wp.innerHTML = "";
    const waiting = payload.lists.waiting_pickup || [];
    if (waiting.length === 0) {
      wp.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:#64748b;">No waiting pickup orders.</td></tr>`;
    } else {
      waiting.forEach(o => {
        wp.innerHTML += `
          <tr>
            <td>${o.order_date}</td>
            <td>${o.product__name}</td>
            <td>${o.campaign__campaign_name}</td>
            <td class="right">‚Çπ ${Number(o.order_value).toFixed(2)}</td>
          </tr>
        `;
      });
    }

    const del = document.getElementById("deliveredBody");
    del.innerHTML = "";
    const delivered = payload.lists.delivered || [];
    if (delivered.length === 0) {
      del.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:#64748b;">No delivered orders.</td></tr>`;
    } else {
      delivered.forEach(o => {
        del.innerHTML += `
          <tr>
            <td>${o.order_date}</td>
            <td>${o.product__name}</td>
            <td>${o.agency__name}</td>
            <td class="right">‚Çπ ${Number(o.order_value).toFixed(2)}</td>
          </tr>
        `;
      });
    }
  }

  function destroyCharts() {
    [chartRevenueLine, chartPlatformDoughnut, chartTopProductsBar, chartTopAgenciesPie, chartTopAdsPolar, chartCampaignMixed]
      .forEach(ch => { if (ch) ch.destroy(); });
  }

  function renderCharts(payload) {
    destroyCharts();

    const d = payload.charts.daily_revenue || [];
    const labels = d.map(x => x.order_date);
    const values = d.map(x => Number(x.revenue));

    chartRevenueLine = new Chart(document.getElementById("revenueLine"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Revenue (‚Çπ)",
          data: values,
          borderColor: COLORS[0],
          backgroundColor: "rgba(59, 130, 246, 0.1)",
          tension: 0.4,
          fill: true,
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
          legend: { 
            display: true,
            labels: { font: { family: 'Inter' } }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            grid: { color: 'rgba(148,163,184,0.25)' },
            ticks: { font: { family: 'Inter' } }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: 'Inter' } }
          }
        }
      }
    });

    const ps = payload.charts.platform_split || [];
    chartPlatformDoughnut = new Chart(document.getElementById("platformDoughnut"), {
      type: "doughnut",
      data: {
        labels: ps.map(x => x.platform),
        datasets: [{
          data: ps.map(x => x.orders),
          backgroundColor: COLORS,
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
          legend: { 
            position: "bottom",
            labels: { 
              font: { family: 'Inter' },
              padding: 15
            }
          }
        }
      }
    });

    const tp = payload.charts.top_products || [];
    chartTopProductsBar = new Chart(document.getElementById("topProductsBar"), {
      type: "bar",
      data: {
        labels: tp.map(x => x.product__name),
        datasets: [{
          label: "Revenue (‚Çπ)",
          data: tp.map(x => Number(x.revenue)),
          backgroundColor: tp.map((_, i) => COLORS[i % COLORS.length]),
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
          legend: { display: false }
        },
        scales: {
          x: {
            grid: { color: 'rgba(148,163,184,0.25)' },
            ticks: { font: { family: 'Inter' } }
          },
          y: {
            grid: { display: false },
            ticks: { font: { family: 'Inter', size: 11 } }
          }
        }
      }
    });

    const ta = payload.charts.top_agencies || [];
    chartTopAgenciesPie = new Chart(document.getElementById("topAgenciesPie"), {
      type: "pie",
      data: {
        labels: ta.map(x => x.agency__name),
        datasets: [{
          data: ta.map(x => x.orders),
          backgroundColor: COLORS,
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
          legend: { 
            position: "bottom",
            labels: { 
              font: { family: 'Inter' },
              padding: 15
            }
          }
        }
      }
    });

    const ads = payload.charts.top_ads || [];
    chartTopAdsPolar = new Chart(document.getElementById("topAdsPolar"), {
      type: "polarArea",
      data: {
        labels: ads.map(x => x.campaign__campaign_name),
        datasets: [{
          data: ads.map(x => x.orders),
          backgroundColor: COLORS.map(c => c + '99'),
          borderWidth: 2,
          borderColor: COLORS
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
          legend: { 
            position: "bottom",
            labels: { 
              font: { family: 'Inter' },
              padding: 15
            }
          }
        }
      }
    });

    const cp = payload.charts.campaign_perf || [];
    chartCampaignMixed = new Chart(document.getElementById("campaignMixed"), {
      data: {
        labels: cp.map(x => x.campaign__campaign_name),
        datasets: [
          {
            type: "bar",
            label: "Orders",
            data: cp.map(x => x.orders),
            backgroundColor: "rgba(59, 130, 246, 0.7)",
            borderRadius: 6,
            yAxisID: "y"
          },
          {
            type: "line",
            label: "Spend (‚Çπ)",
            data: cp.map(x => Number(x.spend)),
            borderColor: COLORS[3],
            backgroundColor: "rgba(239, 68, 68, 0.1)",
            tension: 0.4,
            yAxisID: "y1",
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            labels: { font: { family: 'Inter' } }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            position: "left",
            grid: { color: 'rgba(148,163,184,0.25)' },
            ticks: { font: { family: 'Inter' } }
          },
          y1: { 
            beginAtZero: true,
            position: "right",
            grid: { drawOnChartArea: false },
            ticks: { font: { family: 'Inter' } }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: 'Inter' } }
          }
        }
      }
    });
  }

  function renderKPIs(payload) {
    document.getElementById("kpiOrders").textContent = payload.kpis.total_orders;
    document.getElementById("kpiRevenue").textContent = "‚Çπ " + Number(payload.kpis.total_revenue).toFixed(2);
    document.getElementById("kpiItems").textContent = payload.kpis.total_items;
    document.getElementById("kpiSpend").textContent = "‚Çπ " + Number(payload.kpis.total_ads_spend).toFixed(2);

    // Profit & ROI
    const gp = payload.kpis.gross_profit ?? 0;
    const roi = payload.kpis.roi ?? 0;
    document.getElementById("kpiProfit").textContent = "‚Çπ " + Number(gp).toFixed(2);
    document.getElementById("kpiROI").textContent = Number(roi).toFixed(1) + "%";

    // Optional KPIs (safe)
    if(document.getElementById("kpiAOV")){
      const aov = payload.kpis.avg_order_value ?? 0;
      document.getElementById("kpiAOV").textContent = "‚Çπ " + Number(aov).toFixed(2);
    }
    if(document.getElementById("kpiCPO")){
      const cpo = payload.kpis.overall_cpo ?? 0;
      document.getElementById("kpiCPO").textContent = "‚Çπ " + Number(cpo).toFixed(2);
    }

    document.getElementById("dateRangeText").textContent = `Showing: ${payload.meta.start_date} to ${payload.meta.end_date}`;
  }

  async function refresh() {
    setLoading(true);
    const url = buildUrl();
    const res = await fetch(url);
    const payload = await res.json();

    renderKPIs(payload);
    renderCharts(payload);
    renderTables(payload);

    setLoading(false);
  }

  document.querySelectorAll("#presetChips a").forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      document.querySelectorAll("#presetChips a").forEach(x => x.classList.remove("active"));
      a.classList.add("active");
      currentPreset = a.dataset.preset;

      document.getElementById("customDateBox").style.display = (currentPreset === "custom") ? "block" : "none";
      refresh();
    });
  });

  document.getElementById("platformSelect").addEventListener("change", refresh);
  document.getElementById("agencySelect").addEventListener("change", refresh);

  document.getElementById("applyCustomBtn")?.addEventListener("click", (e) => {
    e.preventDefault();
    refresh();
  });

  // Enable Enter key on KPI cards (accessibility)
  document.querySelectorAll(".kpi-clickable").forEach(el=>{
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        el.click();
      }
    });
  });

  // Dark mode toggle (persist)
  const themeBtn = document.getElementById("themeToggle");
  (function initTheme(){
    const saved = localStorage.getItem("theme");
    if(saved === "dark"){
      document.body.classList.add("dark");
      themeBtn.textContent = "‚òÄÔ∏è Light";
    } else {
      themeBtn.textContent = "üåô Dark";
    }
  })();
  themeBtn.addEventListener("click", ()=>{
    document.body.classList.toggle("dark");
    const dark = document.body.classList.contains("dark");
    localStorage.setItem("theme", dark ? "dark" : "light");
    themeBtn.textContent = dark ? "‚òÄÔ∏è Light" : "üåô Dark";
  });

  (function init() {
    const initialPayload = {{ payload|safe }};
    renderCharts(initialPayload);
    renderTables(initialPayload);
    // also render KPIs for optional fields formatting
    renderKPIs(initialPayload);
  })();
</script>

</body>
</html>
