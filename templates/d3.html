<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons: Phosphor Icons (High class, smooth icons) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      /* Sober Professional Palette (Light Mode) */
      --bg-body: #f1f5f9; /* Slate 100 */
      --bg-card: #ffffff;
      --bg-hover: #f8fafc;
      
      --text-main: #0f172a; /* Slate 900 */
      --text-muted: #64748b; /* Slate 500 */
      
      --border: #e2e8f0; /* Slate 200 */
      --border-hover: #cbd5e1;
      
      --primary: #334155; /* Slate 700 - Professional Dark */
      --accent: #4f46e5; /* Indigo 600 - Data highlights */
      
      /* Semantic Colors */
      --success-bg: #dcfce7; --success-text: #166534;
      --danger-bg: #fee2e2;  --danger-text: #991b1b;
      --warning-bg: #fef3c7; --warning-text: #92400e;
      
      --radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.dark {
      /* Dark Mode Palette */
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      
      --border: #334155;
      --border-hover: #475569;
      
      --primary: #f8fafc;
      --accent: #818cf8; /* Lighter indigo */
      
      --success-bg: #064e3b; --success-text: #dcfce7;
      --danger-bg: #7f1d1d;  --danger-text: #fecaca;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      padding: 32px;
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* --- Layout & Typography --- */
    .container {
      max-width: 1500px;
      margin: 0 auto;
    }

    h2 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.025em;
      color: var(--text-main);
    }

    .muted {
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin: 40px 0 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* --- Cards --- */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      overflow: hidden;
    }

    /* --- Top Bar --- */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
    }

    .topbar-actions {
      display: flex;
      gap: 12px;
    }

    button {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-family: 'Inter', sans-serif;
    }

    button:hover {
      background: var(--bg-hover);
      border-color: var(--border-hover);
      transform: translateY(-1px);
    }
    
    button.primary-btn {
      background: var(--text-main); /* Inverted for high contrast */
      color: var(--bg-card);
      border-color: var(--text-main);
    }
    button.primary-btn:hover {
      opacity: 0.9;
    }

    /* --- Filters --- */
    .filter-card {
      padding: 24px;
      margin-bottom: 32px;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    select, input[type="date"] {
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--bg-body);
      color: var(--text-main);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      min-width: 160px;
      outline: none;
      transition: var(--transition);
      cursor: pointer;
    }

    select:hover, input[type="date"]:hover {
      border-color: var(--border-hover);
    }
    select:focus, input[type="date"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Chips */
    .chips-container {
      display: flex;
      gap: 8px;
      background: var(--bg-body);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .chip {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      text-decoration: none;
      transition: var(--transition);
    }

    .chip:hover {
      color: var(--text-main);
    }

    .chip.active {
      background: var(--bg-card);
      color: var(--text-main);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 600;
    }
    
    body.dark .chip.active {
      background: var(--bg-hover);
    }

    /* --- KPI Grid --- */
    .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
    
    .kpi-card {
      padding: 24px;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 140px;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--border-hover);
    }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
    }

    .kpi-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
    }

    /* Icons inside a circle */
    .kpi-icon-box {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .kpi-value {
      font-size: 30px;
      font-weight: 700;
      color: var(--text-main);
      letter-spacing: -0.03em;
      margin-top: auto; /* Push to bottom */
    }

    /* Specific Colors for Icons */
    .icon-blue { background: #eff6ff; color: #3b82f6; }
    .icon-green { background: #f0fdf4; color: #10b981; }
    .icon-purple { background: #f5f3ff; color: #8b5cf6; }
    .icon-orange { background: #fff7ed; color: #f97316; }
    .icon-red { background: #fef2f2; color: #ef4444; }
    
    body.dark .icon-blue { background: rgba(59,130,246,0.15); }
    body.dark .icon-green { background: rgba(16,185,129,0.15); }
    body.dark .icon-purple { background: rgba(139,92,246,0.15); }
    body.dark .icon-orange { background: rgba(249,115,22,0.15); }
    body.dark .icon-red { background: rgba(239,68,68,0.15); }

    /* --- Charts --- */
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 24px; }

    .chart-card {
      padding: 24px;
      min-height: 380px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .badge {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 4px 8px;
      border-radius: 6px;
      background: var(--bg-body);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    canvas {
      width: 100% !important;
      max-height: 300px;
    }

    /* --- Tables --- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th {
      text-align: left;
      background-color: #f1f1f1;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 14px 16px;
      font-size: 13px;
      color: var(--text-main);
      border-bottom: 1px solid var(--bg-body);
      vertical-align: middle;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--bg-hover); }

    .text-right { text-align: right; }
    .font-mono { font-family: monospace; font-size: 12px; }
    
    /* Status Pills */
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-good { background: var(--success-bg); color: var(--success-text); }
    .status-bad { background: var(--danger-bg); color: var(--danger-text); }
    .status-warn { background: var(--warning-bg); color: var(--warning-text); }

    /* Underperforming Agency Row Highlight */
    .row-highlight {
      background: var(--danger-bg) !important;
    }
    .row-highlight td {
      color: var(--danger-text);
      border-bottom-color: rgba(0,0,0,0.05);
    }

    /* Loading Spinner */
    .loading-overlay {
      position: absolute; inset: 0; background: var(--bg-card);
      opacity: 0.7; display: none; place-items: center; z-index: 10;
    }
    .loading .loading-overlay { display: grid; }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 13px;
      opacity: 0.6;
    }

    /* Media Queries */
    @media (max-width: 1200px) {
      .grid4 { grid-template-columns: repeat(2, 1fr); }
      .grid3 { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .grid4, .grid3, .grid2 { grid-template-columns: 1fr; }
      .topbar { flex-direction: column; align-items: flex-start; gap: 16px; }
      .filter-card { flex-direction: column; align-items: stretch; }
      .chips-container { overflow-x: auto; max-width: 100%; }
    }
  </style>
</head>
<body>

<div class="container">
  
  <!-- Header -->
  <div class="topbar">
    <div>
      <div style="display:flex; align-items:center; gap:10px;">
        <i class="ph ph-chart-polar" style="font-size:28px; color:var(--accent);"></i>
        <h2>Business Analytics</h2>
      </div>
      <div class="muted" id="dateRangeText" style="margin-top:4px;">
        Loading dates...
      </div>
    </div>
    <div class="topbar-actions">
      <button id="themeToggle"><i class="ph ph-moon"></i> Dark Mode</button>
      <!-- <button class="primary-btn" onclick="window.print()"><i class="ph ph-download-simple"></i> Export</button> -->
    </div>
  </div>

  <!-- Filters -->
  <div class="card filter-card">
    <div class="input-group">
      <label class="input-label">Platform</label>
      <select id="platformSelect">
        {% for opt in platform_options %}
          <option value="{{ opt }}" {% if opt == platform %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="input-group">
      <label class="input-label">Agency</label>
      <select id="agencySelect">
        {% for opt in agency_options %}
          <option value="{{ opt }}" {% if opt == agency %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="input-group" style="flex-grow: 1;">
      <label class="input-label">Time Period</label>
      <div class="chips-container" id="presetChips">
        <a class="chip {% if preset == 'today' %}active{% endif %}" href="#" data-preset="today">Today</a>
        <a class="chip {% if preset == 'this_week' %}active{% endif %}" href="#" data-preset="this_week">This Week</a>
        <a class="chip {% if preset == 'this_month' %}active{% endif %}" href="#" data-preset="this_month">This Month</a>
        <a class="chip {% if preset == 'last_month' %}active{% endif %}" href="#" data-preset="last_month">Last Month</a>
        <a class="chip {% if preset == 'custom' %}active{% endif %}" href="#" data-preset="custom">Custom</a>
      </div>
    </div>

    <!-- Custom Dates (Hidden by default logic handled by JS) -->
    <div id="customDateBox" style="display: {% if preset == 'custom' %}flex{% else %}none{% endif %}; gap:12px;">
      <div class="input-group">
        <label class="input-label">From</label>
        <input type="date" id="fromDate" value="{{ from_date }}">
      </div>
      <div class="input-group">
        <label class="input-label">To</label>
        <input type="date" id="toDate" value="{{ to_date }}">
      </div>
      <button id="applyCustomBtn" class="primary-btn" style="height: 42px; margin-top: auto;">Apply</button>
    </div>
  </div>

  <div class="section-title"><i class="ph ph-gauge"></i> Key Performance Indicators</div>

  <!-- KPI Grid 1 -->
  <div class="grid4" id="kpiGrid">
    <div class="card kpi-card" onclick="drilldown('orders')">
      <div class="kpi-header">
        <span class="kpi-title">Total Orders</span>
        <div class="kpi-icon-box icon-blue"><i class="ph ph-package"></i></div>
      </div>
      <div class="kpi-value" id="kpiOrders">{{ payload.kpis.total_orders }}</div>
    </div>

    <div class="card kpi-card" onclick="drilldown('revenue')">
      <div class="kpi-header">
        <span class="kpi-title">Total Revenue</span>
        <div class="kpi-icon-box icon-green"><i class="ph ph-currency-inr"></i></div>
      </div>
      <div class="kpi-value" id="kpiRevenue">₹ {{ payload.kpis.total_revenue }}</div>
    </div>

    <div class="card kpi-card" onclick="drilldown('items')">
      <div class="kpi-header">
        <span class="kpi-title">Items Sold</span>
        <div class="kpi-icon-box icon-purple"><i class="ph ph-shopping-cart"></i></div>
      </div>
      <div class="kpi-value" id="kpiItems">{{ payload.kpis.total_items }}</div>
    </div>

    <div class="card kpi-card" onclick="drilldown('spend')">
      <div class="kpi-header">
        <span class="kpi-title">Ads Spend</span>
        <div class="kpi-icon-box icon-red"><i class="ph ph-megaphone"></i></div>
      </div>
      <div class="kpi-value" id="kpiSpend">₹ {{ payload.kpis.total_ads_spend }}</div>
    </div>
  </div>

  <!-- KPI Grid 2 -->
  <div class="grid4" id="kpiGrid2">
    <div class="card kpi-card" onclick="drilldown('profit')">
      <div class="kpi-header">
        <span class="kpi-title">Gross Profit</span>
        <div class="kpi-icon-box icon-green"><i class="ph ph-trend-up"></i></div>
      </div>
      <div class="kpi-value" id="kpiProfit">₹ {{ payload.kpis.gross_profit|default:0 }}</div>
    </div>

    <div class="card kpi-card" onclick="drilldown('roi')">
      <div class="kpi-header">
        <span class="kpi-title">ROI</span>
        <div class="kpi-icon-box icon-blue"><i class="ph ph-percent"></i></div>
      </div>
      <div class="kpi-value" id="kpiROI">{{ payload.kpis.roi|default:0 }}%</div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-header">
        <span class="kpi-title">Avg Order Value</span>
        <div class="kpi-icon-box icon-orange"><i class="ph ph-receipt"></i></div>
      </div>
      <div class="kpi-value" id="kpiAOV">₹ {{ payload.kpis.avg_order_value|default:0 }}</div>
    </div>

    <div class="card kpi-card">
      <div class="kpi-header">
        <span class="kpi-title">Cost per Order</span>
        <div class="kpi-icon-box icon-red"><i class="ph ph-target"></i></div>
      </div>
      <div class="kpi-value" id="kpiCPO">₹ {{ payload.kpis.overall_cpo|default:0 }}</div>
    </div>
  </div>

  <div class="section-title"><i class="ph ph-presentation-chart"></i> Visual Trends</div>

  <!-- Charts Row 1 -->
  <div class="grid2" id="chartsTop">
    <div class="card chart-card">
      <div class="chart-header">
        <span class="chart-title">Daily Revenue Trend</span>
        <!-- <span class="badge">Line</span> -->
      </div>
      <div style="position: relative; height: 100%;">
         <canvas id="revenueLine"></canvas>
      </div>
    </div>

    <div class="card chart-card">
      <div class="chart-header">
        <span class="chart-title">Orders by Platform</span>
        <!-- <span class="badge">Doughnut</span> -->
      </div>
      <div style="position: relative; height: 100%; display:flex; justify-content:center;">
        <canvas id="platformDoughnut"></canvas>
      </div>
    </div>
  </div>

  <!-- Charts Row 2 -->
  <div class="grid3" id="chartsMid">
    <div class="card chart-card">
      <div class="chart-header">
        <span class="chart-title">Top Products (Revenue)</span>
      </div>
      <canvas id="topProductsBar"></canvas>
    </div>

    <div class="card chart-card">
      <div class="chart-header">
        <span class="chart-title">Top Agencies</span>
      </div>
      <div style="display:flex; justify-content:center;">
        <canvas id="topAgenciesPie"></canvas>
      </div>
    </div>

    <div class="card chart-card">
      <div class="chart-header">
        <span class="chart-title">Ad Performance</span>
      </div>
      <div style="display:flex; justify-content:center;">
        <canvas id="topAdsPolar"></canvas>
      </div>
    </div>
  </div>

  <!-- Campaign Performance (Mixed) -->
  <div class="card chart-card" id="campaignCard" style="margin-bottom: 24px;">
    <div class="chart-header">
      <span class="chart-title">Campaign Effectiveness (Cost vs Orders)</span>
      <span class="badge">Mixed Analysis</span>
    </div>
    <canvas id="campaignMixed" style="max-height:350px;"></canvas>
    
    <div style="margin-top: 30px; overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Campaign Name</th>
            <th class="text-right">Orders</th>
            <th class="text-right">Spend</th>
            <th class="text-right">CPO</th>
          </tr>
        </thead>
        <tbody id="campaignTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Underperforming Agencies -->
  <div class="card" style="padding: 24px; margin-bottom: 32px;" id="underperformCard">
    <div class="chart-header" style="margin-bottom: 10px;">
      <span class="chart-title" style="color:var(--danger-text); display:flex; align-items:center; gap:8px;">
        <i class="ph ph-warning-circle"></i> Underperforming Agencies
      </span>
      <span class="badge" style="border-color:var(--danger-text); color:var(--danger-text);">Action Required</span>
    </div>
    <p class="muted" style="margin-bottom: 16px;">These agencies have a high Cost Per Order (CPO) relative to sales volume.</p>
    
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Agency</th>
            <th class="text-right">Orders</th>
            <th class="text-right">Total Spend</th>
            <th class="text-right">CPO</th>
            <th class="text-right">Status</th>
          </tr>
        </thead>
        <tbody id="agencyPerfBody"></tbody>
      </table>
    </div>
  </div>

  <div class="section-title"><i class="ph ph-list-dashes"></i> Transaction Details</div>

  <div class="grid3" id="listsGrid">
    <!-- Recent Orders -->
    <div class="card" style="padding: 0;">
      <div style="padding: 20px; border-bottom:1px solid var(--border);">
        <span class="chart-title">Recent Orders</span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Date</th><th>Product</th><th class="text-right">Amt</th><th>Status</th></tr></thead>
          <tbody id="recentOrdersBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Pickup Pending -->
    <div class="card" style="padding: 0;">
      <div style="padding: 20px; border-bottom:1px solid var(--border);">
        <span class="chart-title">Waiting Pickup</span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Date</th><th>Product</th><th class="text-right">Amt</th></tr></thead>
          <tbody id="waitingPickupBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Delivered -->
    <div class="card" style="padding: 0;">
      <div style="padding: 20px; border-bottom:1px solid var(--border);">
        <span class="chart-title">Recently Delivered</span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Date</th><th>Product</th><th class="text-right">Amt</th></tr></thead>
          <tbody id="deliveredBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<div class="footer">
  <p>© 2025 Zappkode Solutions | Dropshipping Analytics Dashboard v2.0</p>
</div>

<script>
  /* --- Configuration --- */
  // Sober Color Palette for Charts
  const CHART_COLORS = [
    '#4f46e5', // Indigo
    '#10b981', // Emerald
    '#f59e0b', // Amber
    '#06b6d4', // Cyan
    '#ec4899', // Pink
    '#8b5cf6', // Violet
    '#64748b'  // Slate
  ];

  // Chart Global Defaults for Professional Look
  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.color = '#64748b';
  Chart.defaults.scale.grid.color = 'rgba(226, 232, 240, 0.6)'; // Subtle grid
  Chart.defaults.plugins.tooltip.backgroundColor = '#1e293b';
  Chart.defaults.plugins.tooltip.padding = 10;
  Chart.defaults.plugins.tooltip.cornerRadius = 8;

  let chartRevenueLine, chartPlatformDoughnut, chartTopProductsBar, chartTopAgenciesPie, chartTopAdsPolar, chartCampaignMixed;
  let currentPreset = "{{ preset }}";

  function qs() {
    return {
      preset: currentPreset,
      platform: document.getElementById("platformSelect").value,
      agency: document.getElementById("agencySelect").value,
      from: document.getElementById("fromDate") ? document.getElementById("fromDate").value : "",
      to: document.getElementById("toDate") ? document.getElementById("toDate").value : "",
    };
  }

  function buildUrl() {
    const p = qs();
    const url = new URL("/api/dashboard-data/", window.location.origin);
    url.searchParams.set("preset", p.preset);
    url.searchParams.set("platform", p.platform);
    url.searchParams.set("agency", p.agency);
    if (p.preset === "custom") {
      url.searchParams.set("from", p.from);
      url.searchParams.set("to", p.to);
    }
    return url.toString();
  }

  function drilldown(view){
    const p = qs();
    const url = new URL("/orders/", window.location.origin);
    url.searchParams.set("view", view);
    url.searchParams.set("preset", p.preset);
    url.searchParams.set("platform", p.platform);
    url.searchParams.set("agency", p.agency);
    if(p.preset === "custom"){
      url.searchParams.set("from", p.from);
      url.searchParams.set("to", p.to);
    }
    window.location.href = url.toString();
  }

  // Helper to format currency
  const fmtMoney = (val) => "₹ " + Number(val).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function renderTables(payload) {
    const campBody = document.getElementById("campaignTableBody");
    campBody.innerHTML = "";
    const camps = payload.charts.campaign_perf || [];
    
    if (camps.length === 0) {
      campBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-muted);">No campaign data available.</td></tr>`;
    } else {
      camps.forEach(c => {
        campBody.innerHTML += `
          <tr>
            <td style="font-weight:500;">${c.campaign__campaign_name}</td>
            <td class="text-right font-mono">${c.orders}</td>
            <td class="text-right font-mono">${fmtMoney(c.spend)}</td>
            <td class="text-right font-mono">${fmtMoney(c.cpo)}</td>
          </tr>
        `;
      });
    }

    // Underperforming agencies
    const ap = document.getElementById("agencyPerfBody");
    ap.innerHTML = "";
    const agencies = payload.underperforming_agencies || [];
    
    if(!agencies.length){
      ap.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">All agencies performing within targets.</td></tr>`;
    } else {
      agencies.forEach(a => {
        const isBad = a.status === "UNDERPERFORMING";
        const statusClass = isBad ? "status-bad" : "status-good";
        const rowClass = isBad ? "row-highlight" : "";
        
        ap.innerHTML += `
          <tr class="${rowClass}">
            <td style="font-weight:600;">${a.agency__name}</td>
            <td class="text-right font-mono">${a.orders}</td>
            <td class="text-right font-mono">${fmtMoney(a.spend)}</td>
            <td class="text-right font-mono">${fmtMoney(a.cpo)}</td>
            <td class="text-right"><span class="status-pill ${statusClass}">${a.status}</span></td>
          </tr>
        `;
      });
    }

    // Small Lists
    const populateList = (id, data, cols) => {
      const el = document.getElementById(id);
      el.innerHTML = "";
      if (!data || data.length === 0) {
        el.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; padding:20px; color:var(--text-muted);">No records found.</td></tr>`;
        return;
      }
      data.forEach(o => {
        let statusHtml = o.status ? `<td><span class="status-pill status-good" style="font-size:10px;">${o.status}</span></td>` : '';
        el.innerHTML += `
          <tr>
            <td style="font-size:12px; color:var(--text-muted);">${o.order_date}</td>
            <td style="max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${o.product__name}">${o.product__name}</td>
            <td class="text-right font-mono">${fmtMoney(o.order_value)}</td>
            ${statusHtml}
          </tr>
        `;
      });
    };

    populateList("recentOrdersBody", payload.lists.recent_orders, 4);
    populateList("waitingPickupBody", payload.lists.waiting_pickup, 3);
    populateList("deliveredBody", payload.lists.delivered, 3);
  }

  function destroyCharts() {
    [chartRevenueLine, chartPlatformDoughnut, chartTopProductsBar, chartTopAgenciesPie, chartTopAdsPolar, chartCampaignMixed]
      .forEach(ch => { if (ch) ch.destroy(); });
  }

  function renderCharts(payload) {
    destroyCharts();

    // 1. Line Chart (Revenue)
    const d = payload.charts.daily_revenue || [];
    chartRevenueLine = new Chart(document.getElementById("revenueLine"), {
      type: "line",
      data: {
        labels: d.map(x => x.order_date),
        datasets: [{
          label: "Revenue",
          data: d.map(x => Number(x.revenue)),
          borderColor: CHART_COLORS[0],
          backgroundColor: (ctx) => {
            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.2)');
            gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');
            return gradient;
          },
          tension: 0.4,
          fill: true,
          pointRadius: 0,
          pointHoverRadius: 6,
          borderWidth: 2
        }]
      },
      options: { 
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { display: false } },
        scales: { 
          x: { grid: { display: false } },
          y: { beginAtZero: true, grid: { borderDash: [2, 4] } } 
        }
      }
    });

    // 2. Doughnut (Platform)
    const ps = payload.charts.platform_split || [];
    chartPlatformDoughnut = new Chart(document.getElementById("platformDoughnut"), {
      type: "doughnut",
      data: {
        labels: ps.map(x => x.platform),
        datasets: [{
          data: ps.map(x => x.orders),
          backgroundColor: CHART_COLORS,
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: { 
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } },
        cutout: '70%'
      }
    });

    // 3. Bar (Top Products)
    const tp = payload.charts.top_products || [];
    chartTopProductsBar = new Chart(document.getElementById("topProductsBar"), {
      type: "bar",
      data: {
        labels: tp.map(x => x.product__name.substring(0, 20) + (x.product__name.length > 20 ? '...' : '')),
        datasets: [{
          label: "Revenue",
          data: tp.map(x => Number(x.revenue)),
          backgroundColor: CHART_COLORS[1],
          borderRadius: 4,
          barThickness: 20
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { 
          x: { grid: { display: false } },
          y: { grid: { display: false } }
        }
      }
    });

    // 4. Pie (Agencies)
    const ta = payload.charts.top_agencies || [];
    chartTopAgenciesPie = new Chart(document.getElementById("topAgenciesPie"), {
      type: "pie",
      data: {
        labels: ta.map(x => x.agency__name),
        datasets: [{
          data: ta.map(x => x.orders),
          backgroundColor: CHART_COLORS,
          borderWidth: 0
        }]
      },
      options: { 
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } }
      }
    });

    // 5. Polar (Ads)
    const ads = payload.charts.top_ads || [];
    chartTopAdsPolar = new Chart(document.getElementById("topAdsPolar"), {
      type: "polarArea",
      data: {
        labels: ads.map(x => x.campaign__campaign_name),
        datasets: [{
          data: ads.map(x => x.orders),
          backgroundColor: CHART_COLORS.map(c => c + '80'), // Add transparency
          borderWidth: 0
        }]
      },
      options: { 
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } },
        scales: { r: { grid: { color: 'rgba(0,0,0,0.05)' } } }
      }
    });

    // 6. Mixed (Campaigns)
    const cp = payload.charts.campaign_perf || [];
    chartCampaignMixed = new Chart(document.getElementById("campaignMixed"), {
      data: {
        labels: cp.map(x => x.campaign__campaign_name),
        datasets: [
          {
            type: "bar",
            label: "Orders",
            data: cp.map(x => x.orders),
            backgroundColor: CHART_COLORS[0],
            borderRadius: 4,
            order: 2,
            yAxisID: 'y'
          },
          {
            type: "line",
            label: "Spend (₹)",
            data: cp.map(x => Number(x.spend)),
            borderColor: CHART_COLORS[2],
            backgroundColor: CHART_COLORS[2],
            borderWidth: 2,
            pointRadius: 3,
            order: 1,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { grid: { display: false } },
          y: { type: 'linear', display: true, position: 'left', grid: { display:false } },
          y1: { type: 'linear', display: true, position: 'right', grid: { display:false } },
        }
      }
    });
  }

  function renderKPIs(payload) {
    const safeText = (id, val) => {
      const el = document.getElementById(id);
      if(el) el.textContent = val;
    };
    
    safeText("kpiOrders", payload.kpis.total_orders);
    safeText("kpiRevenue", fmtMoney(payload.kpis.total_revenue));
    safeText("kpiItems", payload.kpis.total_items);
    safeText("kpiSpend", fmtMoney(payload.kpis.total_ads_spend));
    
    safeText("kpiProfit", fmtMoney(payload.kpis.gross_profit || 0));
    safeText("kpiROI", (payload.kpis.roi || 0) + "%");
    safeText("kpiAOV", fmtMoney(payload.kpis.avg_order_value || 0));
    safeText("kpiCPO", fmtMoney(payload.kpis.overall_cpo || 0));

    document.getElementById("dateRangeText").textContent = `${payload.meta.start_date} — ${payload.meta.end_date}`;
  }

  async function refresh() {
    // Add loading visuals (simple opacity drop)
    document.querySelector('.container').style.opacity = '0.6';
    
    try {
      const url = buildUrl();
      const res = await fetch(url);
      const payload = await res.json();
  
      renderKPIs(payload);
      renderCharts(payload);
      renderTables(payload);
    } catch(e) {
      console.error("Failed to load data", e);
    } finally {
      document.querySelector('.container').style.opacity = '1';
    }
  }

  // Event Listeners
  document.querySelectorAll("#presetChips a").forEach(a => {
    a.addEventListener("click", (e) => {
      e.preventDefault();
      document.querySelectorAll("#presetChips a").forEach(x => x.classList.remove("active"));
      a.classList.add("active");
      currentPreset = a.dataset.preset;

      const customBox = document.getElementById("customDateBox");
      if (currentPreset === "custom") {
        customBox.style.display = "flex";
      } else {
        customBox.style.display = "none";
        refresh(); // Refresh immediately for non-custom
      }
    });
  });

  document.getElementById("platformSelect").addEventListener("change", refresh);
  document.getElementById("agencySelect").addEventListener("change", refresh);
  
  document.getElementById("applyCustomBtn")?.addEventListener("click", (e) => {
    e.preventDefault();
    refresh();
  });

  // Theme Logic
  const themeBtn = document.getElementById("themeToggle");
  const initTheme = () => {
    const saved = localStorage.getItem("theme");
    if(saved === "dark"){
      document.body.classList.add("dark");
      themeBtn.innerHTML = '<i class="ph ph-sun"></i> Light Mode';
    } else {
      themeBtn.innerHTML = '<i class="ph ph-moon"></i> Dark Mode';
    }
    // Update charts if they exist
    if(chartRevenueLine) refresh(); 
  };
  
  themeBtn.addEventListener("click", ()=>{
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    themeBtn.innerHTML = isDark ? '<i class="ph ph-sun"></i> Light Mode' : '<i class="ph ph-moon"></i> Dark Mode';
    refresh(); // Re-render charts for correct colors
  });

  // Init
  (function init() {
    initTheme();
    const initialPayload = {{ payload|safe }};
    renderKPIs(initialPayload);
    renderCharts(initialPayload);
    renderTables(initialPayload);
  })();
</script>

</body>
</html>